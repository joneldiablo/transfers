/*
 *  transfers - v4.1.0
 *  A jump-start for jQuery plugins development.
 *  
 *
 *  Made by JD-R2
 *  Under MIT License
 */
!function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend(!0,{},{jqgrid:{ondblClickRow:m,onSelectRow:l,beforeProcessing:n},select2:{ajax:{data:i,processResults:j},escapeMarkup:k,templateResult:g,templateSelection:h}},r,c),this.settings.jqgrid.colModel.filter(function(a){if("origen"===a.name||"destino"===a.name)return a.formatter=o,a.unformat=p,a}),this._defaults=r,this._name=q,this.init()}function f(a){return a.replace(/-([a-z])/gi,function(a,b){return b.toUpperCase()})}function g(a){return a.sucursal}function h(a){return a.sucursal}function i(a){return{q:a.term,page:a.page}}function j(a,b){return b.page=b.page||1,console.log(a,b),{results:a,pagination:{more:30*b.page<a.total_count}}}function k(a){return a}function l(b,c,d){var e=a(this),f=e.jqGrid("getGridParam","savedRow");f.length>0&&f[0].id!==b&&e.jqGrid("restoreRow",f[0].id)}function m(b,c,d,e){a(this).jqGrid("editRow",b,{focusField:e.target})}function n(b){a.each(b.productos,function(c,d){d.origen=d.inventario;var e=[].concat(d.inventario,b.sucursales),f=[];e=a.grep(e,function(b){return-1===a.inArray(b.id,f)&&-1===a.inArray(b.sucursal,f)&&(f.push(b.id),f.push(b.sucursal),!0)}),d.destino=e})}function o(b,c,d){console.log(d);var e=a("<div>"),f=a("<select>",{class:"form-control"});return a.each(b,function(b,c){var d=c.sucursal+(c.cantidad?" - "+c.cantidad:""),e=a("<option>",{value:c.id}).text(d);f.append(e)}),e.append(f),e.html()}function p(a,b,c){return""}var q="transfers",r={marca:!0,title:"Transferencias entre sucursales",jqgrid:{url:"http://localhost:3000/transferencias",jsonReader:{root:"productos"},colNames:["","Producto","Marca","Origen","Destino","Cantidad",""],colModel:[{name:"id",hidden:!0,editable:!1,search:!1},{name:"producto",align:"left",editable:!1},{name:"marca",align:"left",editable:!1},{name:"origen",autoResizing:{minColWidth:80},editable:!1,search:!1,sortable:!1},{name:"destino",autoResizing:{minColWidth:80},editable:!1,search:!1,sortable:!1},{name:"cantidad",autoResizing:{minColWidth:80},sortable:!1,editable:!0,search:!1},{name:"act",width:80,template:"actions",formatoptions:{delbutton:!1}}],datatype:"json",hidegrid:!1,loadonce:!0,navOptions:{reloadGridOptions:{fromServer:!0}},altRows:!0,autowidth:!0,shrinkToFit:!0,viewrecords:!0,loadui:!0,autoresizeOnLoad:!0,cmTemplate:{autoResizable:!0,editable:!0},guiStyle:"bootstrap",iconSet:"fontAwesome",rowNum:10,autoResizing:{compact:!0},rowList:[10,20,50],autoencode:!0,sortable:!0,pager:!0,inlineEditing:{keys:!0,defaultFocusField:"origen",focusField:"origen"},rownumbers:!1,caption:"",grouping:!1,groupingView:{groupField:["sucursal"],groupColumnShow:[!0],groupText:[""],groupOrder:["asc"],groupSummary:[!1],groupSummaryPos:["header"],groupCollapse:!0}},select2:{language:"es",minimumInputLength:0,multiple:!1,ajax:{url:"http://localhost:3000/sucursales",dataType:"json",delay:250,cache:!0}}};a.extend(e.prototype,{init:function(){var c=this;c.settings.marca||(c.settings.jqgrid.colNames.splice(2,1),c.settings.jqgrid.colModel.splice(2,1));var d=a("<div>",{class:"card-box transfers"}),e=a("<h4>",{class:"header-title m-t-0 m-b-30"}).text(c.settings.title),f=a("<div>",{class:"row"}).append("<div class = 'col-sm-12' ></div>"),g=a("<div>",{class:"form-group col-sm-4"}),h=a("<label>",{for:"productsFilter",class:"control-label"}).text("Producto"),i=a("<input>",{type:"text",class:"form-control",id:"productsFilter"}),j=g.clone(),k=a("<input>",{type:"button",class:"form-control btn btn-primary disabled",id:"clearFilter",value:"Limpiar filtros",disabled:"disabled",css:{marginTop:25}}).click(function(){c.filterClear()}),l=a("<table>");d.append(e,f,l),f.find("div").append(g,j),g.append(h,i),j.append(k),a(c.element).append(d),c.$grid=l,c.$inputProductsFilter=i,c.$inputClearFilter=k,l.jqGrid(c.settings.jqgrid).jqGrid("gridResize").jqGrid("bindKeys").jqGrid("navGrid",{edit:!1,add:!1,del:!1,search:!0,refresh:!0},{},{},{},{closeAfterSearch:!0,multipleSearch:!0,multipleGroup:!0}),i.on("keyup",function(){return c.keyupDelay||(c.keyupDelay=setTimeout(function(){var a=i.val();c.filterByProducts(a),c.keyupDelay=!1},300)),!1}),a(".ui-jqgrid-title").click(function(){a(this).parent().find(".ui-jqgrid-titlebar-close").click()}),a(".ui-jqgrid-titlebar-close, .ui-pg-button").click(function(){setTimeout(function(){a(b).resize()},200)}),l.on("jqGridInlineAfterSaveRow",function(b,d){var e=l.jqGrid("getRowData",d);a(c.element).trigger("transfers.saveRow",e)}),l.on("jqGridInlineEditRow",function(b,c,d){a("#"+c).find("input").addClass("form-control")}),a(b).resize(function(){l.setGridWidth(l.closest(".ui-jqgrid").parent().innerWidth(!0))}).trigger("resize"),l.on("jqGridFilterBeforeShow",function(a,b){b.closest(".ui-jqdialog").addClass("transfers")}),l.on("jqGridFilterReset",function(a){}),l.on("jqGridAfterLoadComplete",function(){c.$grid.jqGrid("getGridParam","search")||c.filterDomClear()})},filterGet:function(){var a,b=this.$grid.jqGrid("getGridParam","postData");try{a=JSON.parse(b.filters)}catch(c){return!1}return"object"!=typeof a.groups&&(a.groups=[]),a},filterObj:function(){return{groupOp:"AND",groups:[]}},filterSet:function(a){return this.$grid.jqGrid("getGridParam","postData").filters=JSON.stringify(a),this.$grid.jqGrid("setGridParam",{search:!0}),this.$grid.trigger("reloadGrid",[{page:1,current:!0}]),this.$inputClearFilter.removeClass("disabled").prop("disabled",!1),!0},filterClear:function(){return this.$grid.jqGrid("getGridParam","postData").filters="",this.$grid.jqGrid("setGridParam",{search:!1}),this.$grid.trigger("reloadGrid",[{page:1,current:!0}]),this.filterDomClear(),!0},filterDomClear:function(){this.$inputProductsFilter.val(""),this.$inputClearFilter.addClass("disabled").prop("disabled",!0)},filterByProducts:function(a){var b=this.filterGet();return b||(b=this.filterObj()),b.groups.filter(function(b){if("products"===b.criteria)return b.rules=[{field:"producto",op:"cn",data:a}],b}).length<1&&b.groups.push({criteria:"products",groupOp:"OR",rules:[{field:"producto",op:"cn",data:a}]}),this.filterSet(b),!0},filterRmProduct:function(){var a=this.filterGet();return!a||(a=a.groups.filter(function(a){if("products"!==a.criteria)return a}),this.filterSet(a),!0)},help:function(){var b=a.map(this,function(a,b){if("function"==typeof a)return b});return console.log("defaults"),console.log(r),console.log("mÃ©todos disponibles"),console.log(b),console.log("------------"),[JSON.stringify(r),JSON.stringify(b)]},helloW:function(b){return"text: "+b+", my index: "+a(this.element).text(b).index()}}),a.fn[q]=function(b,c){var d;if("string"!=typeof b)c=b,d=this.each(function(b,d){a.data(d,"plugin_"+q)||a.data(d,"plugin_"+q,new e(d,c))});else switch(d=this.map(function(d,g){var h,i=a.data(g,"plugin_"+q);return i||(i=new e(g,c),a.data(g,"plugin_"+q,i)),"function"==typeof i[f(b)]&&(h=i[f(b)](c)),h}).get(),d.length){case 0:d=null;break;case 1:d=d[0]}return d}}(jQuery,window,document);